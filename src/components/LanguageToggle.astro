---
const LANGUAGES = [
	{ code: "en", name: "English", flag: "ðŸ‡ºðŸ‡¸" },
	{ code: "es", name: "EspaÃ±ol", flag: "ðŸ‡ªðŸ‡¸" },
];
---

<div class="relative ml-1 mr-1">
	<button
		id="language-toggle-btn"
		class="appearance-none border-none flex hover:scale-125 transition items-center gap-1.5 px-2 py-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800"
		aria-label="Select language"
	>
		<span class="sr-only">Select language</span>
		<!-- Language icon -->
		<svg 
			class="size-5 text-gray-700 dark:text-gray-300" 
			fill="none" 
			stroke="currentColor" 
			viewBox="0 0 24 24"
			aria-hidden="true"
		>
			<path 
				stroke-linecap="round" 
				stroke-linejoin="round" 
				stroke-width="2" 
				d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"
			/>
		</svg>
		<!-- Current language name -->
		<span id="current-language-name" class="text-sm font-medium text-gray-700 dark:text-gray-300">English</span>
	</button>
	<div
		id="language-menu"
		class="absolute hidden scale-80 top-10 right-0 text-sm p-1 min-w-[10rem] rounded-lg border border-gray-200 bg-white/95 dark:bg-gray-900/95 dark:border-gray-700 shadow-[0_4px_12px_rgb(0,0,0,0.15)] backdrop-blur-md z-50"
	>
		<ul class="space-y-1">
			{LANGUAGES.map((lang) => (
				<li
					class="language-menu-option px-3 py-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md flex items-center transition-colors"
					data-lang={lang.code}
				>
					<span class="font-medium text-gray-900 dark:text-gray-100">{lang.name}</span>
				</li>
			))}
		</ul>
	</div>
</div>

<style>
	#language-menu.open {
		display: inline;
		animation: scale-up-center 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
	}

	@keyframes scale-up-center {
		from {
			transform: scale(0.8);
			opacity: 0;
		}
		to {
			transform: scale(1);
			opacity: 1;
		}
	}
</style>

<script is:inline>
	(function() {
		const DEFAULT_LANGUAGE = "en";
		
		function getLanguage() {
			if (typeof localStorage !== "undefined") {
				const stored = localStorage.getItem("language");
				return stored === "en" || stored === "es" ? stored : DEFAULT_LANGUAGE;
			}
			return DEFAULT_LANGUAGE;
		}

		function updateLanguageName(lang) {
			const currentLanguageName = document.getElementById("current-language-name");
			if (currentLanguageName) {
				const name = lang === "es" ? "EspaÃ±ol" : "English";
				currentLanguageName.textContent = name;
			}
		}

		function updatePageLanguage(lang) {
			document.documentElement.lang = lang;
			const event = new CustomEvent("languagechange", { detail: { language: lang } });
			document.dispatchEvent(event);
		}

		function initLanguage() {
			const lang = getLanguage();
			updateLanguageName(lang);
			updatePageLanguage(lang);
		}

		function setupLanguageToggle() {
			const languageMenu = document.getElementById("language-menu");
			const toggleBtn = document.getElementById("language-toggle-btn");

			if (!languageMenu || !toggleBtn) {
				return;
			}

			// Toggle menu on button click
			toggleBtn.addEventListener("click", function(e) {
				e.stopPropagation();
				const isClosed = !languageMenu.classList.contains("open");
				languageMenu.classList[isClosed ? "add" : "remove"]("open");
			});

			// Handle language selection
			document.querySelectorAll(".language-menu-option").forEach(function(element) {
				element.addEventListener("click", function(e) {
					e.stopPropagation();
					const lang = element.getAttribute("data-lang");
					if (lang && (lang === "en" || lang === "es")) {
						localStorage.setItem("language", lang);
						updateLanguageName(lang);
						updatePageLanguage(lang);
						languageMenu.classList.remove("open");
						// Reload page to apply translations
						window.location.reload();
					}
				});
			});
		}

		function init() {
			initLanguage();
			setupLanguageToggle();

			// Close menu when clicking outside
			document.addEventListener("click", function(e) {
				const languageMenu = document.getElementById("language-menu");
				const toggleBtn = document.getElementById("language-toggle-btn");
				if (languageMenu && toggleBtn && 
					!languageMenu.contains(e.target) && 
					!toggleBtn.contains(e.target)) {
					languageMenu.classList.remove("open");
				}
			});
		}

		// Initialize when DOM is ready
		if (document.readyState === "loading") {
			document.addEventListener("DOMContentLoaded", init);
		} else {
			init();
		}

		// Re-initialize on Astro page load
		document.addEventListener("astro:page-load", init);
	})();
</script>
